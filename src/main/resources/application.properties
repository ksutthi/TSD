# ============================================================
# ACTIVE SPRING PROFILE
# ============================================================
spring.profiles.active=local

server.port=8081

# ============================================================
# 1. PRIMARY DATABASE: TSD Registry (Persistent)
# ============================================================
spring.datasource.url=jdbc:sqlserver://localhost:1433;databaseName=TSD_Registry;encrypt=false
spring.datasource.username=sa
spring.datasource.password=NewPassword123!
spring.datasource.driverClassName=com.microsoft.sqlserver.jdbc.SQLServerDriver

# ============================================================
# 2. SECONDARY DATABASE: SET OneID (Mock Identity)
# ============================================================
spring.datasource.oneid.url=jdbc:sqlserver://localhost:1433;databaseName=SET_One_ID;encrypt=false
spring.datasource.oneid.username=sa
spring.datasource.oneid.password=NewPassword123!
spring.datasource.oneid.driverClassName=com.microsoft.sqlserver.jdbc.SQLServerDriver

# ============================================================
# 3. HIBERNATE / JPA (The Persistence Logic)
# ============================================================
spring.jpa.database-platform=org.hibernate.dialect.SQLServerDialect
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
spring.jpa.hibernate.naming.implicit-strategy=org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy

# CRITICAL FOR AUDITABILITY (P1 MANDATE):
# Changed from 'update' to 'validate'. Hibernate will no longer alter tables.
# It will only check if the Kotlin Entities match the Flyway database schema.
spring.jpa.hibernate.ddl-auto=validate

# DEBUGGING: Show the SQL in the logs so we know it's saving!
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
logging.level.org.hibernate.SQL=DEBUG
# logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# ============================================================
# 4. FLYWAY MIGRATION (The Schema Enforcer)
# ============================================================
spring.flyway.enabled=true
# Tells Flyway not to crash if it finds existing tables created by Hibernate earlier
spring.flyway.baseline-on-migrate=true
# Tells Flyway to assume the existing tables are at version 2,
# so it will immediately execute V3 and V4 on startup.
spring.flyway.baseline-version=2

# ============================================================
# 5. SPRING BATCH (Stop automatic wipes)
# ============================================================
# 'never' = Assume tables exist. Don't run init scripts that might drop/reset data.
spring.batch.jdbc.initialize-schema=never
spring.batch.job.enabled=false

# ? THE TRAP IS SET: Turn off overriding to force a crash if a duplicate bean exists!
spring.main.allow-bean-definition-overriding=false

# ============================================================
# 6. LOGGING
# ============================================================
logging.level.org.jooq.Constants=WARN
# logging.level.org.hibernate.orm.jdbc.bind=TRACE

# ==========================================================================================
# RESILIENCE4J CONFIGURATION (Circuit Breaker)
# ==========================================================================================
# Rule: If 50% of the last 10 calls fail, OPEN the circuit (Stop calling).
resilience4j.circuitbreaker.instances.identity-service.sliding-window-size=10
resilience4j.circuitbreaker.instances.identity-service.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.identity-service.wait-duration-in-open-state=10s
resilience4j.circuitbreaker.instances.identity-service.permitted-number-of-calls-in-half-open-state=3

# ===================================================================
# DATA ISOLATION (REGISTRAR AND PARTICIPANT) SECURITY MATRIX CONFIGURATION TOGGLE
# ===================================================================
# Toggle to TRUE to enforce JWT-based Data Isolation (Brokers/Registrars)
# Toggle to FALSE for local testing/debugging to allow open access
tsd.security.registrar-and-participant-data-isolation.enabled=false

# The cryptographic signing key for our JWTs (Must be at least 256-bit / 32 characters)
tsd.security.jwt.secret=Th1sIsAVerySecureAndLongSecretKeyForTSDPlatform2026!

# Tell Spring Boot to include the traceId in the console logs
logging.pattern.console=%d{HH:mm:ss.SSS} [%t] %-5level [traceId=%X{traceId:-}] %logger{36} - %msg%n
# Force Micrometer to sample and trace 100% of requests (default is usually 10%)
management.tracing.sampling.probability=1.0
